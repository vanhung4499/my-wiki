---
title: TransmittableThreadLocal
tags:
  - java
  - microservice
categories:
  - project
order: 4
---
# PmHub - Save user information with TransmittableThreadLocal

::: info
+ D·ª±a tr√™n **TransmittableThreadLocal (TTL)** ƒë·ªÉ t√πy ch·ªânh tr√¨nh ch·∫∑n request header, ƒë√≥ng g√≥i d·ªØ li·ªáu header v√†o bi·∫øn lu·ªìng ƒë·ªÉ d·ªÖ d√†ng truy xu·∫•t, gi·∫£m s·ªë l·∫ßn truy v·∫•n c∆° s·ªü d·ªØ li·ªáu v·ªÅ th√¥ng tin ng∆∞·ªùi d√πng, ƒë·ªìng th·ªùi x√°c minh v√† t·ª± ƒë·ªông l√†m m·ªõi th·ªùi gian hi·ªáu l·ª±c c·ªßa ng∆∞·ªùi d√πng hi·ªán t·∫°i.
:::

# Ki·∫øn th·ª©c l√Ω thuy·∫øt

**TransmittableThreadLocal (TTL)** l√† phi√™n b·∫£n n√¢ng cao c·ªßa ThreadLocal, v√¨ v·∫≠y ƒë·ªÉ hi·ªÉu TTL, tr∆∞·ªõc ti√™n c·∫ßn √¥n l·∫°i ki·∫øn th·ª©c c∆° b·∫£n v·ªÅ ThreadLocal.

## Gi·ªõi thi·ªáu ThreadLocal
### ThreadLocal l√† g√¨?

**ThreadLocal** l√† m·ªôt l·ªõp trong g√≥i **lang** c·ªßa Java, ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ **<font style="color:#DF2A3F;">ƒë·ªìng th·ªùi khi chia s·∫ª bi·∫øn</font>** gi·ªØa nhi·ªÅu lu·ªìng. Chia s·∫ª bi·∫øn nghƒ©a l√† c√πng m·ªôt bi·∫øn c√≥ th·ªÉ ƒë∆∞·ª£c g√°n c√°c gi√° tr·ªã kh√°c nhau trong c√°c lu·ªìng kh√°c nhau.

ThreadLocal duy tr√¨ **b·∫£n sao bi·∫øn ri√™ng bi·ªát** cho m·ªói lu·ªìng trong m√¥i tr∆∞·ªùng ƒëa lu·ªìng, cho ph√©p m·ªói lu·ªìng c√≥ b·∫£n sao d·ªØ li·ªáu c·ªßa ri√™ng m√¨nh, tr√°nh xung ƒë·ªôt khi nhi·ªÅu lu·ªìng c√πng truy c·∫≠p v√†o m·ªôt bi·∫øn.

![20200930144753491.png](https://raw.githubusercontent.com/vanhung4499/images/master/snap/20200930144753491.png)

### S·ª± kh√°c bi·ªát gi·ªØa ThreadLocal v√† Synchronized?

**Synchronized** d·ª±a tr√™n c∆° ch·∫ø kh√≥a, ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ ki·ªÉm so√°t vi·ªác truy c·∫≠p v√†o t√†i nguy√™n chia s·∫ª, ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n v√† an to√†n c·ªßa d·ªØ li·ªáu gi·ªØa c√°c lu·ªìng, b·∫±ng c√°ch cho ph√©p c√°c lu·ªìng truy c·∫≠p m·ªôt c√°ch tu·∫ßn t·ª±.

**Synchronized d√πng th·ªùi gian ƒë·ªÉ ƒë·ªïi l·∫•y kh√¥ng gian b·∫±ng c√°ch x·∫øp h√†ng c√°c lu·ªìng ƒë·ªÉ truy c·∫≠p, trong khi ThreadLocal d√πng kh√¥ng gian ƒë·ªÉ ƒë·ªïi l·∫•y th·ªùi gian b·∫±ng c√°ch cung c·∫•p m·ªôt b·∫£n sao bi·∫øn cho m·ªói lu·ªìng, t·ª´ ƒë√≥ ƒë·∫°t ƒë∆∞·ª£c c√°ch ly gi·ªØa c√°c lu·ªìng.** (B·∫°n c√≥ th·ªÉ n√≥i tr·ª±c ti·∫øp ƒëi·ªÅu n√†y v·ªõi ng∆∞·ªùi ph·ªèng v·∫•n üëä).

### C√°c tr∆∞·ªùng h·ª£p s·ª≠ d·ª•ng ThreadLocal

**ThreadLocal** ch·ªß y·∫øu ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ th·ª±c hi·ªán vi·ªác c√°ch ly d·ªØ li·ªáu gi·ªØa c√°c lu·ªìng. D∆∞·ªõi ƒë√¢y l√† m·ªôt s·ªë tr∆∞·ªùng h·ª£p s·ª≠ d·ª•ng ph·ªï bi·∫øn:

**1. Th√¥ng tin phi√™n ng∆∞·ªùi d√πng**

Trong c√°c ·ª©ng d·ª•ng web, m·ªói y√™u c·∫ßu th∆∞·ªùng ƒë∆∞·ª£c x·ª≠ l√Ω trong m·ªôt lu·ªìng ri√™ng bi·ªát. B·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng ThreadLocal ƒë·ªÉ l∆∞u tr·ªØ th√¥ng tin phi√™n c·ªßa m·ªói ng∆∞·ªùi d√πng, tr√°nh s·ª± nh·∫ßm l·∫´n d·ªØ li·ªáu gi·ªØa c√°c lu·ªìng y√™u c·∫ßu kh√°c nhau.

```java
public class UserContext {
    private static ThreadLocal<String> userHolder = ThreadLocal.withInitial(() -> null);

    public static void setUser(String user) {
        userHolder.set(user);
    }

    public static String getUser() {
        return userHolder.get();
    }

    public static void clear() {
        userHolder.remove();
    }
}

// S·ª≠ d·ª•ng trong m·ªôt lu·ªìng x·ª≠ l√Ω y√™u c·∫ßu
UserContext.setUser("UserA");
String currentUser = UserContext.getUser();
System.out.println("Ng∆∞·ªùi d√πng hi·ªán t·∫°i: " + currentUser);
UserContext.clear();
```

**2. Qu·∫£n l√Ω k·∫øt n·ªëi c∆° s·ªü d·ªØ li·ªáu**

L∆∞u tr·ªØ k·∫øt n·ªëi c∆° s·ªü d·ªØ li·ªáu trong lu·ªìng, ƒë·ªÉ m·ªói lu·ªìng c√≥ m·ªôt th·ªÉ hi·ªán k·∫øt n·ªëi c∆° s·ªü d·ªØ li·ªáu ri√™ng, tr√°nh v·∫•n ƒë·ªÅ chia s·∫ª k·∫øt n·ªëi v√† c·∫£i thi·ªán hi·ªáu su·∫•t.

```java
public class ConnectionManager {
    private static ThreadLocal<Connection> connectionHolder = ThreadLocal.withInitial(() -> {
        try {
            return DriverManager.getConnection("jdbc:your_database_url");
        } catch (SQLException e) {
            throw new RuntimeException(e);
        }
    });

    public static Connection getConnection() {
        return connectionHolder.get();
    }

    public static void closeConnection() throws SQLException {
        connectionHolder.get().close();
        connectionHolder.remove();
    }
}

// S·ª≠ d·ª•ng trong m·ªôt lu·ªìng
Connection connection = ConnectionManager.getConnection();
// Th·ª±c hi·ªán thao t√°c v·ªõi c∆° s·ªü d·ªØ li·ªáu
ConnectionManager.closeConnection();
```

**3. C√¥ng c·ª• ƒë·ªãnh d·∫°ng**

V√≠ d·ª• nh∆∞ `SimpleDateFormat` kh√¥ng an to√†n khi s·ª≠ d·ª•ng trong ƒëa lu·ªìng, b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng `ThreadLocal` ƒë·ªÉ cung c·∫•p m·ªôt th·ªÉ hi·ªán `SimpleDateFormat` ƒë·ªôc l·∫≠p cho m·ªói lu·ªìng, tr√°nh v·∫•n ƒë·ªÅ an to√†n lu·ªìng.

```java
public class DateFormatter {
    private static ThreadLocal<SimpleDateFormat> dateFormatHolder = ThreadLocal.withInitial(() -> new SimpleDateFormat("yyyy-MM-dd"));

    public static String format(Date date) {
        return dateFormatHolder.get().format(date);
    }
}

// S·ª≠ d·ª•ng trong m·ªôt lu·ªìng
String formattedDate = DateFormatter.format(new Date());
System.out.println("Ng√†y ƒë·ªãnh d·∫°ng: " + formattedDate);
```

**4. Truy·ªÅn th√¥ng tin ng·ªØ c·∫£nh nh·∫≠t k√Ω**

Trong ghi nh·∫≠t k√Ω, b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng `ThreadLocal` ƒë·ªÉ l∆∞u tr·ªØ m·ªôt s·ªë th√¥ng tin ng·ªØ c·∫£nh (nh∆∞  request ID, user ID, v.v.), ƒë·ªÉ c√≥ th·ªÉ chia s·∫ª th√¥ng tin ng·ªØ c·∫£nh n√†y trong c√°c ghi nh·∫≠t k√Ω kh√°c nhau.

```java
public class LogContext {
    private static ThreadLocal<String> requestIdHolder = ThreadLocal.withInitial(() -> null);

    public static void setRequestId(String requestId) {
        requestIdHolder.set(requestId);
    }

    public static String getRequestId() {
        return requestIdHolder.get();
    }

    public static void clear() {
        requestIdHolder.remove();
    }
}

// S·ª≠ d·ª•ng trong m·ªôt lu·ªìng x·ª≠ l√Ω y√™u c·∫ßu
LogContext.setRequestId("123456");
String requestId = LogContext.getRequestId();
System.out.println("Request ID: " + requestId);
LogContext.clear();
```

## Nguy√™n l√Ω c·ªßa ThreadLocal

### C·∫•u tr√∫c n·ªôi b·ªô c·ªßa ThreadLocal

`ThreadLocal` l√† m·ªôt l·ªõp generic, m·ª•c ƒë√≠ch ch√≠nh c·ªßa n√≥ l√† cung c·∫•p m·ªôt container ƒë·ªÉ l∆∞u tr·ªØ c√°c bi·∫øn c·ª•c b·ªô theo t·ª´ng lu·ªìng. M·ªói lu·ªìng c√≥ m·ªôt ƒë·ªëi t∆∞·ª£ng `ThreadLocalMap`, c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ l∆∞u tr·ªØ t·∫•t c·∫£ c√°c ƒë·ªëi t∆∞·ª£ng `ThreadLocal` v√† gi√° tr·ªã t∆∞∆°ng ·ª©ng c·ªßa ch√∫ng trong lu·ªìng ƒë√≥.

Vi·ªác tri·ªÉn khai n·ªôi b·ªô c·ªßa `ThreadLocal` r·∫•t ƒë∆°n gi·∫£n, ch·ªß y·∫øu l√† ba ph∆∞∆°ng th·ª©c sau:

+ `get()`: L·∫•y `ThreadLocalMap` c·ªßa lu·ªìng hi·ªán t·∫°i, n·∫øu t√¨m th·∫•y gi√° tr·ªã t∆∞∆°ng ·ª©ng v·ªõi key (hi·ªán t·∫°i l√† `ThreadLocal`) th√¨ tr·∫£ v·ªÅ gi√° tr·ªã ƒë√≥. N·∫øu `ThreadLocalMap` tr·ªëng ho·∫∑c kh√¥ng t√¨m th·∫•y gi√° tr·ªã, th√¨ tr·∫£ v·ªÅ gi√° tr·ªã m·∫∑c ƒë·ªãnh.
+ `set(T value)`: L·∫•y lu·ªìng hi·ªán t·∫°i, l·∫•y `ThreadLocalMap` c·ªßa lu·ªìng (n·∫øu kh√¥ng c√≥ th√¨ t·∫°o m·ªôt `map` m·ªõi), sau ƒë√≥ thi·∫øt l·∫≠p `ThreadLocal` hi·ªán t·∫°i l√† key v√† `value` l√† gi√° tr·ªã v√†o trong `map`.
+ `initialValue`: Gi√° tr·ªã kh·ªüi t·∫°o, c√≥ th·ªÉ ƒë∆∞·ª£c k·∫ø th·ª´a, thi·∫øt l·∫≠p gi√° tr·ªã m·∫∑c ƒë·ªãnh khi kh·ªüi t·∫°o.

![image.png](https://raw.githubusercontent.com/vanhung4499/images/master/snap/20240917004006.png)

### C·∫•u tr√∫c c∆° b·∫£n c·ªßa ThreadLocalMap

Bao g·ªìm 2 th√†nh ph·∫ßn:

1. L·ªõp n·ªôi b·ªô tƒ©nh `ThreadLocal`.
2. Key l√† ƒë·ªëi t∆∞·ª£ng `ThreadLocal` v·ªõi ki·ªÉu tham chi·∫øu y·∫øu, m·ª•c ƒë√≠ch l√† ƒë·ªÉ g·ª° r·ªëi m·ªëi quan h·ªá gi·ªØa v√≤ng ƒë·ªùi c·ªßa ƒë·ªëi t∆∞·ª£ng `ThreadLocal` v√† v√≤ng ƒë·ªùi c·ªßa lu·ªìng.

![image.png](https://raw.githubusercontent.com/vanhung4499/images/master/snap/20240917004109.png)


## Gi·ªõi thi·ªáu v·ªÅ TransmittableThreadLocal (TTL)

### TTL l√† g√¨?

TransmittableThreadLocal (TTL) l√† m·ªôt th∆∞ vi·ªán m√£ ngu·ªìn m·ªü do Alibaba ph√°t tri·ªÉn, nh·∫±m gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ **kh√¥ng th·ªÉ truy·ªÅn th√¥ng tin ng·ªØ c·∫£nh t·ª´ lu·ªìng cha ƒë·∫øn lu·ªìng con** khi s·ª≠ d·ª•ng ThreadLocal trong Java v·ªõi c√°c khung ƒëa lu·ªìng ho·∫∑c c√°c c√¥ng c·ª• nh∆∞ Executors, ForkJoinPool, v.v. TTL m·ªü r·ªông InheritableThreadLocal ƒë·ªÉ cho ph√©p truy·ªÅn th√¥ng tin ng·ªØ c·∫£nh qua c√°c lu·ªìng trong pool.

> ƒê·ªãa ch·ªâ m√£ ngu·ªìn m·ªü c·ªßa TTL: [https://github.com/alibaba/transmittable-thread-local](https://github.com/alibaba/transmittable-thread-local)

To√†n b·ªô th∆∞ vi·ªán TransmittableThreadLocal c√≥ ch·ª©c nƒÉng c·ªët l√µi r·∫•t nh·ªè g·ªçn (~1000 d√≤ng m√£), bao g·ªìm API ng∆∞·ªùi d√πng, wrapper cho ExecutorService/ForkJoinPool/TimerTask v√† c√°c API t√≠ch h·ª£p cho framework/middleware. üëç

### Nguy√™n l√Ω ho·∫°t ƒë·ªông c·ªßa TTL

Trong l·∫≠p tr√¨nh ƒëa lu·ªìng Java, ThreadLocal th∆∞·ªùng ƒë∆∞·ª£c d√πng ƒë·ªÉ l∆∞u tr·ªØ bi·∫øn c·ª•c b·ªô c·ªßa lu·ªìng. Tuy nhi√™n, khi s·ª≠ d·ª•ng thread pool, c√°c lu·ªìng c√≥ th·ªÉ ƒë∆∞·ª£c t√°i s·ª≠ d·ª•ng, d·∫´n ƒë·∫øn vi·ªác c√°c bi·∫øn ThreadLocal kh√¥ng ƒë∆∞·ª£c truy·ªÅn ƒë√∫ng c√°ch gi·ªØa c√°c lu·ªìng cha v√† con, g√¢y ra m·∫•t d·ªØ li·ªáu ho·∫∑c kh√¥ng nh·∫•t qu√°n d·ªØ li·ªáu. M·∫∑c d√π InheritableThreadLocal c√≥ th·ªÉ truy·ªÅn bi·∫øn c·ªßa lu·ªìng cha cho lu·ªìng con, nh∆∞ng v·∫´n kh√¥ng gi·∫£i quy·∫øt ƒë∆∞·ª£c v·∫•n ƒë·ªÅ t√°i s·ª≠ d·ª•ng lu·ªìng trong m√¥i tr∆∞·ªùng thread pool.

Nguy√™n l√Ω ho·∫°t ƒë·ªông ch√≠nh c·ªßa TTL bao g·ªìm ba b∆∞·ªõc:

+ **Sao ch√©p ng·ªØ c·∫£nh**: Khi nhi·ªám v·ª• ƒë∆∞·ª£c n·ªôp, TTL s·∫Ω sao ch√©p ng·ªØ c·∫£nh c·ªßa lu·ªìng hi·ªán t·∫°i v√†o nhi·ªám v·ª•.
+ **Thi·∫øt l·∫≠p ng·ªØ c·∫£nh tr∆∞·ªõc khi th·ª±c hi·ªán nhi·ªám v·ª•**: Tr∆∞·ªõc khi nhi·ªám v·ª• ƒë∆∞·ª£c th·ª±c hi·ªán, TTL s·∫Ω thi·∫øt l·∫≠p ng·ªØ c·∫£nh ƒë√£ sao ch√©p v√†o lu·ªìng hi·ªán t·∫°i.
+ **D·ªçn d·∫πp ng·ªØ c·∫£nh sau khi th·ª±c hi·ªán nhi·ªám v·ª•**: Sau khi nhi·ªám v·ª• ho√†n t·∫•t, TTL s·∫Ω d·ªçn d·∫πp ng·ªØ c·∫£nh trong lu·ªìng ƒë·ªÉ tr√°nh r√≤ r·ªâ b·ªô nh·ªõ.

D∆∞·ªõi ƒë√¢y l√† h√¨nh minh h·ªça r√µ r√†ng v·ªÅ nguy√™n l√Ω ho·∫°t ƒë·ªông c·ªßa TTL:

![image.png](https://raw.githubusercontent.com/vanhung4499/images/master/snap/20240917004325.png)

### C√°c tr∆∞·ªùng h·ª£p s·ª≠ d·ª•ng ch√≠nh c·ªßa TTL

C√°c t√¨nh hu·ªëng c·∫ßn s·ª≠ d·ª•ng ThreadLocal ch√≠nh l√† c√°c t√¨nh hu·ªëng ti·ªÅm nƒÉng c·∫ßn TransmittableThreadLocal, n·∫øu c√¥ng vi·ªác c·ªßa b·∫°n y√™u c·∫ßu ‚Äútruy·ªÅn gi√° tr·ªã ThreadLocal khi s·ª≠ d·ª•ng c√°c th√†nh ph·∫ßn th·ª±c thi c√≥ th·ªÉ t√°i s·ª≠ d·ª•ng lu·ªìng nh∆∞ thread pool‚Äù, th√¨ ƒë√≥ l√† m·ª•c ti√™u c·ªßa TransmittableThreadLocal.

+ **Theo d√µi ph√¢n t√°n**: Truy·ªÅn ID theo d√µi trong h·ªá th·ªëng ph√¢n t√°n ƒë·ªÉ d·ªÖ d√†ng li√™n k·∫øt log v√† x·ª≠ l√Ω s·ª± c·ªë.
+ **Qu·∫£n l√Ω giao d·ªãch**: Truy·ªÅn ng·ªØ c·∫£nh giao d·ªãch trong c√°c giao d·ªãch ph√¢n t√°n ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n c·ªßa giao d·ªãch.
+ **Truy·ªÅn th√¥ng tin ng·ªØ c·∫£nh**: Truy·ªÅn th√¥ng tin v·ªÅ phi√™n ng∆∞·ªùi d√πng, ng·ªØ c·∫£nh y√™u c·∫ßu, v.v., trong m√¥i tr∆∞·ªùng ƒëa lu·ªìng.

##  ∆Øu ƒëi·ªÉm c·ªßa TTL so v·ªõi ThreadLocal

D∆∞·ªõi ƒë√¢y l√† so s√°nh ∆∞u ƒëi·ªÉm gi·ªØa TTL (TransmittableThreadLocal) v√† ThreadLocal:

| ƒê·∫∑c ƒëi·ªÉm                      | ThreadLocal                                                                             | TTL (TransmittableThreadLocal)                                                                        |
| ----------------------------- | --------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------- |
| **Truy·ªÅn th√¥ng tin ng·ªØ c·∫£nh** | Ch·ªâ l∆∞u tr·ªØ trong lu·ªìng hi·ªán t·∫°i, kh√¥ng th·ªÉ truy·ªÅn qua lu·ªìng kh√°c                       | C√≥ th·ªÉ truy·ªÅn th√¥ng tin ng·ªØ c·∫£nh trong c√°c khung ƒëa lu·ªìng v√† c√°c c√¥ng c·ª• qu·∫£n l√Ω lu·ªìng                |
| **H·ªó tr·ª£ t√°i s·ª≠ d·ª•ng lu·ªìng**  | Khi lu·ªìng ƒë∆∞·ª£c t√°i s·ª≠ d·ª•ng trong thread pool, kh√¥ng ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n c·ªßa bi·∫øn      | H·ªó tr·ª£ t√°i s·ª≠ d·ª•ng lu·ªìng, ƒë·∫£m b·∫£o r·∫±ng bi·∫øn ƒë∆∞·ª£c truy·ªÅn v√† gi·ªØ nh·∫•t qu√°n gi·ªØa c√°c t√°c v·ª•              |
| **Kh√¥ng x√¢m l·∫•n**             | C·∫ßn qu·∫£n l√Ω vi·ªác thi·∫øt l·∫≠p v√† x√≥a bi·∫øn th·ªß c√¥ng, d·ªÖ x·∫£y ra l·ªói                          | Thay th·∫ø ThreadLocal l√† c√≥ th·ªÉ t·ª± ƒë·ªông qu·∫£n l√Ω vi·ªác truy·ªÅn v√† x√≥a ng·ªØ c·∫£nh                            |
| **D·ªÖ t√≠ch h·ª£p**               | Ph√π h·ª£p v·ªõi m√¥i tr∆∞·ªùng lu·ªìng ƒë∆°n gi·∫£n                                                   | C√≥ th·ªÉ t√≠ch h·ª£p li·ªÅn m·∫°ch v·ªõi nhi·ªÅu lo·∫°i thread pool v√† khung ƒëa lu·ªìng                                 |
| **T√¨nh hu·ªëng s·ª≠ d·ª•ng**        | Ph√π h·ª£p v·ªõi m√¥i tr∆∞·ªùng ƒë∆°n lu·ªìng ho·∫∑c kh√¥ng c·∫ßn truy·ªÅn th√¥ng tin ng·ªØ c·∫£nh qua c√°c lu·ªìng | Ph√π h·ª£p v·ªõi m√¥i tr∆∞·ªùng ƒëa lu·ªìng ph·ª©c t·∫°p, ƒë·∫∑c bi·ªát l√† khi c·∫ßn truy·ªÅn th√¥ng tin ng·ªØ c·∫£nh qua c√°c lu·ªìng |

Nh·ªØng l·ª£i th·∫ø n√†y khi·∫øn TTL tr·ªü n√™n th·ª±c ti·ªÖn h∆°n trong c√°c m√¥i tr∆∞·ªùng ƒëa lu·ªìng ph·ª©c t·∫°p, ƒë·∫∑c bi·ªát l√† trong c√°c t√¨nh hu·ªëng c·∫ßn truy·ªÅn th√¥ng tin ng·ªØ c·∫£nh qua c√°c lu·ªìng, ch·∫≥ng h·∫°n nh∆∞ ID theo d√µi trong h·ªá th·ªëng ph√¢n t√°n, th√¥ng tin phi√™n ng∆∞·ªùi d√πng, v.v.

## Th·ª±c H√†nh D·ª± √Ån

ƒê√£ n√≥i nhi·ªÅu v·ªÅ l√Ω thuy·∫øt c∆° b·∫£n, hy v·ªçng c√°c b·∫°n c√≥ th·ªÉ hi·ªÉu r√µ, ti·∫øp theo ch√∫ng ta s·∫Ω ƒëi v√†o ph·∫ßn th·ª±c h√†nh, trong PmHub, l√†m th·∫ø n√†o ƒë·ªÉ s·ª≠ d·ª•ng TransmittableThreadLocal (TTL) ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu ng∆∞·ªùi d√πng v√† truy·ªÅn gi·ªØa c√°c lu·ªìng.

::: info
T√¨nh hu·ªëng y√™u c·∫ßu:

Trong ki·∫øn tr√∫c vi d·ªãch v·ª•, t√¥i mu·ªën l∆∞u tr·ªØ th√¥ng tin ng∆∞·ªùi d√πng sau khi ƒëƒÉng nh·∫≠p v√†o bi·∫øn ng·ªØ c·∫£nh v√† truy·ªÅn qua c√°c lu·ªìng.

:::

@startuml

autonumber

actor "User" as User
participant "Browser" as Browser #red
participant "Nginx Server" as Nginx #orange
participant "Gateway" as Gateway #green
participant "Header Interceptor" as HeaderInterceptor
participant "Auth Center" as Auth
participant "User Service" as UserService
participant "Project Service" as ProjectService

group User Login
activate User

User -> Browser: Enter URL to log in to PmHub
activate Browser

Browser -> Nginx: Request to server
note right of Nginx: Load balancing
activate Nginx

Nginx -> Gateway: Forward request to Gateway
note right of Gateway: Gateway forwards service request
activate Gateway

Gateway -> Auth: User login request
activate Auth

Auth -> UserService: Query user information
activate UserService

UserService -> Auth: Return user information
deactivate UserService

Auth -> Browser: Return login status and token
deactivate Auth

Browser --> User: Redirect to homepage after successful login
deactivate Browser

end group

group Access After Login

User -> Browser: Access PmHub
activate Browser

Browser -> Nginx: Request to server
note right of Nginx: Load balancing

Nginx -> Gateway: Forward request to Gateway
Gateway -> Gateway: AuthFilter for gateway authentication
Gateway -> Gateway: AuthFilter for interface time statistics
Gateway -> Gateway: AuthFilter sets user information to request header
note right of Gateway: Gateway forwards service request

Gateway -> HeaderInterceptor: Enter custom request header interceptor
activate HeaderInterceptor
HeaderInterceptor -> HeaderInterceptor: Store user information from request header\n<font color="red">in TTL</font>

HeaderInterceptor -> ProjectService: Request to project service
activate ProjectService
ProjectService -> ProjectService: Project service accesses\nuser information directly from <font color="red">context TTL</font>
ProjectService -> ProjectService: Project service queries\ncurrent user's project information
HeaderInterceptor -> HeaderInterceptor: Clean up user information in <font color="red">TTL</font>
ProjectService -> Browser: Return user's project information
deactivate HeaderInterceptor
deactivate ProjectService

Browser --> User: Display user's project information page
deactivate User
deactivate Browser
deactivate Nginx
deactivate Gateway

end group

@enduml

Sau khi ng∆∞·ªùi d√πng ƒëƒÉng nh·∫≠p, h·ªá th·ªëng s·∫Ω tr·∫£ v·ªÅ m·ªôt token. C√°c y√™u c·∫ßu sau ƒë√≥ s·∫Ω mang theo token n√†y, v√† token ch·ª©a th√¥ng tin c·ªßa ng∆∞·ªùi d√πng. T·∫•t c·∫£ c√°c y√™u c·∫ßu s·∫Ω ƒëi qua b·ªô l·ªçc AuthFilter c·ªßa gateway ƒë·∫ßu ti√™n. Trong b·ªô l·ªçc, th√¥ng tin ng∆∞·ªùi d√πng s·∫Ω ƒë∆∞·ª£c ƒë∆∞a v√†o header c·ªßa y√™u c·∫ßu. Sau khi y√™u c·∫ßu ƒëi qua gateway, n√≥ s·∫Ω ƒë·∫øn b·ªô l·ªçc header t√πy ch·ªânh HeaderInterceptor. Trong b·ªô l·ªçc n√†y, th√¥ng tin ng∆∞·ªùi d√πng t·ª´ header s·∫Ω ƒë∆∞·ª£c ƒë∆∞a v√†o TTL, v√¨ v·∫≠y c√°c d·ªãch v·ª• tr√™n chu·ªói c√≥ th·ªÉ tr·ª±c ti·∫øp l·∫•y th√¥ng tin ng∆∞·ªùi d√πng t·ª´ TTL.

Tr√™n ƒë√¢y l√† quy tr√¨nh th·ª±c hi·ªán. B·∫°n c·∫ßn ph·∫£i t·ª± l√†m quen v·ªõi n√≥, n·∫Øm r√µ v√† c√≥ th·ªÉ gi·∫£i th√≠ch ƒë∆∞·ª£c th√¨ m·ªõi coi l√† ƒë√£ hi·ªÉu. D∆∞·ªõi ƒë√¢y l√† m√£ ngu·ªìn th·ª±c t·∫ø:

**AuthFilter:**

```java
/**
 * Gateway Authentication Filter
 */
@Component
public class AuthFilter implements GlobalFilter, Ordered {
    private static final Logger log = LoggerFactory.getLogger(AuthFilter.class);

    private static final String BEGIN_VISIT_TIME = "begin_visit_time"; // Start visit time

    // URIs to be excluded from filtering, add in nacos
    @Autowired
    private IgnoreWhiteProperties ignoreWhite;

    @Autowired
    private RedisService redisService;

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        ServerHttpRequest.Builder mutate = request.mutate();

        String url = request.getURI().getPath();
        // Skip paths that do not require validation
        if (StringUtils.matches(url, ignoreWhite.getWhites())) {
            return chain.filter(exchange);
        }
        String token = getToken(request);
        if (StringUtils.isEmpty(token)) {
            return unauthorizedResponse(exchange, "Token cannot be empty");
        }
        Claims claims = JwtUtils.parseToken(token);
        if (claims == null) {
            return unauthorizedResponse(exchange, "Token is expired or invalid!");
        }
        String userkey = JwtUtils.getUserKey(claims);
        boolean islogin = redisService.hasKey(getTokenKey(userkey));
        if (!islogin) {
            return unauthorizedResponse(exchange, "Login status has expired");
        }
        String userid = JwtUtils.getUserId(claims);
        String username = JwtUtils.getUserName(claims);
        if (StringUtils.isEmpty(userid) || StringUtils.isEmpty(username)) {
            return unauthorizedResponse(exchange, "Token validation failed");
        }

        // Set user information to the request
        addHeader(mutate, SecurityConstants.USER_KEY, userkey);
        addHeader(mutate, SecurityConstants.DETAILS_USER_ID, userid);
        addHeader(mutate, SecurityConstants.DETAILS_USERNAME, username);
        // Clear internal request source parameters (to prevent security risks)
        removeHeader(mutate, SecurityConstants.FROM_SOURCE);

        // Record the start time of the request
        exchange.getAttributes().put(BEGIN_VISIT_TIME, System.currentTimeMillis());

        return chain.filter(exchange.mutate().request(mutate.build()).build());
    }

    private void addHeader(ServerHttpRequest.Builder mutate, String name, Object value) {
        if (value == null) {
            return;
        }
        String valueStr = value.toString();
        String valueEncode = ServletUtils.urlEncode(valueStr);
        mutate.header(name, valueEncode);
    }

    private void removeHeader(ServerHttpRequest.Builder mutate, String name) {
        mutate.headers(httpHeaders -> httpHeaders.remove(name)).build();
    }

    private Mono<Void> unauthorizedResponse(ServerWebExchange exchange, String msg) {
        log.error("[Authentication Error Handling] Request Path: {}", exchange.getRequest().getPath());
        return ServletUtils.webFluxResponseWriter(exchange.getResponse(), msg, HttpStatus.UNAUTHORIZED);
    }

    /**
     * Get cache key
     */
    private String getTokenKey(String token) {
        return CacheConstants.LOGIN_TOKEN_KEY + token;
    }

    /**
     * Get token from request
     */
    private String getToken(ServerHttpRequest request) {
        String token = request.getHeaders().getFirst(TokenConstants.AUTHENTICATION);
        // If a token prefix is set, remove it
        if (StringUtils.isNotEmpty(token) && token.startsWith(TokenConstants.PREFIX)) {
            token = token.replaceFirst(TokenConstants.PREFIX, StringUtils.EMPTY);
        }
        return token;
    }

    @Override
    public int getOrder() {
        return -200;
    }
}
```

**HeaderInterceptor:**

```java
/**
 * Custom header interceptor to encapsulate Header data into thread variables for easy access
 * Note: This interceptor will also validate and automatically refresh the current user's validity period
 * 
 * @author canghe
 */
public class HeaderInterceptor implements AsyncHandlerInterceptor {

    // Set of paths that do not require login
    private static final Set<String> EXEMPTED_PATHS = new HashSet<>();

    static {
        // Add paths that do not require login here
        EXEMPTED_PATHS.add("/system/user/getInfo");
        EXEMPTED_PATHS.add("/project/statistics");
        EXEMPTED_PATHS.add("/project/doing");
        EXEMPTED_PATHS.add("/project/queryMyTaskList");
        EXEMPTED_PATHS.add("/project/select");
        EXEMPTED_PATHS.add("/system/menu/getRouters");
    }

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        if (!(handler instanceof HandlerMethod)) {
            return true;
        }

        SecurityContextHolder.setUserId(ServletUtils.getHeader(request, SecurityConstants.DETAILS_USER_ID));
        SecurityContextHolder.setUserName(ServletUtils.getHeader(request, SecurityConstants.DETAILS_USERNAME));
        SecurityContextHolder.setUserKey(ServletUtils.getHeader(request, SecurityConstants.USER_KEY));

        String token = SecurityUtils.getToken();
        if (StringUtils.isNotEmpty(token)) {
            LoginUser loginUser = AuthUtil.getLoginUser(token);
            if (StringUtils.isNotNull(loginUser)) {
                AuthUtil.verifyLoginUserExpire(loginUser);
                SecurityContextHolder.set(SecurityConstants.LOGIN_USER, loginUser);
            }
        } else {
            // Display for non-login scenario
            // Check if the request path matches specific paths
            String requestURI = request.getRequestURI();
            if (isExemptedPath(requestURI)) {
                // Create a default LoginUser object
                LoginUser defaultLoginUser = createDefaultLoginUser();
                SecurityContextHolder.set(SecurityConstants.LOGIN_USER, defaultLoginUser);
            }
        }
        return true;
    }

    // Determine if the request path matches specific paths
    private boolean isExemptedPath(String requestURI) {
        // Adjust the path matching logic as needed
        return EXEMPTED_PATHS.stream().anyMatch(requestURI::startsWith);
    }

    // Create a default LoginUser object
    private LoginUser createDefaultLoginUser() {
        LoginUser defaultLoginUser = new LoginUser();
        defaultLoginUser.setUserId(173L);  // Set default user ID
        defaultLoginUser.setUsername(Constants.DEMO_ACCOUNT);  // Set default username

        SysUser demoSysUser = new SysUser();
        demoSysUser.setUserId(173L);
        demoSysUser.setUserName(Constants.DEMO_ACCOUNT);
        demoSysUser.setDeptId(100L);
        demoSysUser.setStatus("0");

        defaultLoginUser.setUser(demoSysUser);
        // Set other necessary default properties
        return defaultLoginUser;
    }

    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
        SecurityContextHolder.remove();
    }
}
```

# C√°c c√¢u h·ªèi ph·ªèng v·∫•n d·ª± ƒëo√°n

:::  info
D∆∞·ªõi ƒë√¢y l√† c√°c c√¢u h·ªèi ph·ªèng v·∫•n c√≥ th·ªÉ g√¢y kh√≥ khƒÉn m√† b·∫°n c√≥ th·ªÉ g·∫∑p ph·∫£i.
:::

### C√°c c√¢u h·ªèi ƒë√†o s√¢u:

1. **TransmittableThreadLocal (TTL) l√† g√¨ v√† m·ª•c ƒë√≠ch ch√≠nh c·ªßa n√≥ l√† g√¨?**
2. **TTL c√≥ nh·ªØng ∆∞u ƒëi·ªÉm g√¨ so v·ªõi ThreadLocal ti√™u chu·∫©n?**
3. **Trong d·ª± √°n c·ªßa b·∫°n, TTL ƒë√£ gi·∫£i quy·∫øt nh·ªØng v·∫•n ƒë·ªÅ c·ª• th·ªÉ n√†o?**
4. **TTL duy tr√¨ th√¥ng tin ng·ªØ c·∫£nh nh∆∞ th·∫ø n√†o trong m√¥i tr∆∞·ªùng thread pool?**
5. **B·∫°n ƒë√£ g·∫∑p ph·∫£i nh·ªØng v·∫•n ƒë·ªÅ g√¨ khi s·ª≠ d·ª•ng TTL? B·∫°n ƒë√£ gi·∫£i quy·∫øt ch√∫ng nh∆∞ th·∫ø n√†o?**
6. **TTL c√≥ ·∫£nh h∆∞·ªüng ƒë·∫øn hi·ªáu su·∫•t kh√¥ng? N·∫øu c√≥, b·∫°n ƒë√£ t·ªëi ∆∞u h√≥a hi·ªáu su·∫•t nh∆∞ th·∫ø n√†o?**
7. **B·∫°n c√≥ c√¢n nh·∫Øc c√°c gi·∫£i ph√°p kh√°c kh√¥ng? T·∫°i sao b·∫°n ch·ªçn TTL?**
8. **L√†m th·∫ø n√†o ƒë·ªÉ tri·ªÉn khai TTL ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu ng∆∞·ªùi d√πng? H√£y m√¥ t·∫£ chi ti·∫øt c√°c b∆∞·ªõc th·ª±c hi·ªán.**
9. **TTL x·ª≠ l√Ω t√¨nh hu·ªëng ƒë·ªìng th·ªùi nh∆∞ th·∫ø n√†o? B·∫°n ƒë√£ g·∫∑p v·∫•n ƒë·ªÅ v·ªÅ an to√†n lu·ªìng ch∆∞a?**
10. **Nguy√™n nh√¢n th·ª±c s·ª± c·ªßa r√≤ r·ªâ b·ªô nh·ªõ v·ªõi ThreadLocal l√† g√¨?**
11. **S·ª± kh√°c bi·ªát gi·ªØa r√≤ r·ªâ b·ªô nh·ªõ v√† tr√†n b·ªô nh·ªõ l√† g√¨?**
12. **ThreadLocalMap gi·∫£i quy·∫øt xung ƒë·ªôt nh∆∞ th·∫ø n√†o?**

### V√≠ d·ª• v·ªÅ ƒë·ªëi tho·∫°i:

**Nh√† tuy·ªÉn d·ª•ng:** Ch√†o m·ª´ng b·∫°n ƒë·∫øn ph·ªèng v·∫•n. H√£y gi·ªõi thi·ªáu ng·∫Øn g·ªçn v·ªÅ b·ªëi c·∫£nh v√† tr√°ch nhi·ªám ch√≠nh khi s·ª≠ d·ª•ng TransmittableThreadLocal (TTL) ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu ng∆∞·ªùi d√πng trong d·ª± √°n c·ªßa b·∫°n.

**·ª®ng vi√™n:** T·∫°i PmHub, v√¨ c·∫ßn ph·∫£i truy·ªÅn th√¥ng tin ng·ªØ c·∫£nh ng∆∞·ªùi d√πng gi·ªØa c√°c h·ªá th·ªëng vi d·ªãch v·ª•, ch√∫ng t√¥i ƒë√£ ch·ªçn s·ª≠ d·ª•ng TTL ƒë·ªÉ th·ª±c hi·ªán ch·ª©c nƒÉng n√†y. T√¥i ch·ªß y·∫øu ph·ª• tr√°ch vi·ªác ƒë∆∞a TTL v√†o s·ª≠ d·ª•ng v√† tri·ªÉn khai c·ª• th·ªÉ, bao g·ªìm vi·ªác truy·ªÅn th√¥ng tin ng·ªØ c·∫£nh v√† l∆∞u tr·ªØ d·ªØ li·ªáu ng∆∞·ªùi d√πng.

**Nh√† tuy·ªÉn d·ª•ng:** B·∫°n c√≥ th·ªÉ gi·∫£i th√≠ch chi ti·∫øt TTL l√† g√¨ kh√¥ng? N√≥ kh√°c g√¨ so v·ªõi ThreadLocal ti√™u chu·∫©n?

**·ª®ng vi√™n:** TTL l√† phi√™n b·∫£n n√¢ng cao c·ªßa ThreadLocal, ch·ªß y·∫øu ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ kh√¥ng th·ªÉ truy·ªÅn th√¥ng tin ng·ªØ c·∫£nh gi·ªØa c√°c lu·ªìng cha v√† con trong c√°c khung ƒëa lu·ªìng nh∆∞ thread pool. Kh√°c v·ªõi ThreadLocal ti√™u chu·∫©n, TTL cho ph√©p c√°c lu·ªìng con k·∫ø th·ª´a c√°c bi·∫øn ThreadLocal t·ª´ lu·ªìng cha.

**Nh√† tuy·ªÉn d·ª•ng:** B·∫°n ƒë√£ ƒë·ªÅ c·∫≠p ƒë·∫øn ThreadLocal. B·∫°n c√≥ th·ªÉ m√¥ t·∫£ c·∫•u tr√∫c n·ªôi b·ªô c·ªßa n√≥ kh√¥ng?

**·ª®ng vi√™n:** Trong ThreadLocal, m·ªói lu·ªìng duy tr√¨ m·ªôt ThreadLocalMap. Map n√†y ƒë∆∞·ª£c qu·∫£n l√Ω b·ªüi ThreadLocal, v·ªõi c√°c kh√≥a l√† c√°c ƒë·ªëi t∆∞·ª£ng ThreadLocal v√† c√°c gi√° tr·ªã l√† c√°c b·∫£n sao bi·∫øn. Map ch·ªß y·∫øu cung c·∫•p c√°c ph∆∞∆°ng th·ª©c `set` v√† `get`.

**Nh√† tuy·ªÉn d·ª•ng:** B·∫°n c√≥ hi·ªÉu c·∫•u tr√∫c c∆° b·∫£n c·ªßa ThreadLocalMap kh√¥ng?

**·ª®ng vi√™n:** ThreadLocalMap l√† l·ªõp n·ªôi b·ªô tƒ©nh c·ªßa ThreadLocal, v·ªõi c√°c kh√≥a l√† tham chi·∫øu y·∫øu ƒë·∫øn c√°c ƒë·ªëi t∆∞·ª£ng ThreadLocal. Thi·∫øt k·∫ø n√†y nh·∫±m t√°ch bi·ªát v√≤ng ƒë·ªùi c·ªßa c√°c ƒë·ªëi t∆∞·ª£ng ThreadLocal kh·ªèi v√≤ng ƒë·ªùi c·ªßa c√°c lu·ªìng.

**Nh√† tuy·ªÉn d·ª•ng:** B·∫°n ƒë√£ n√≥i r·∫±ng c√°c kh√≥a trong ThreadLocalMap s·ª≠ d·ª•ng tham chi·∫øu y·∫øu. ƒêi·ªÅu n√†y c√≥ th·ªÉ g√¢y ra v·∫•n ƒë·ªÅ g√¨?

**·ª®ng vi√™n:** Vi·ªác s·ª≠ d·ª•ng tham chi·∫øu y·∫øu cho c√°c kh√≥a trong ThreadLocalMap c√≥ th·ªÉ d·∫´n ƒë·∫øn r√≤ r·ªâ b·ªô nh·ªõ.

**Nh√† tuy·ªÉn d·ª•ng:** R√≤ r·ªâ b·ªô nh·ªõ l√† g√¨? N√≥ kh√°c g√¨ so v·ªõi tr√†n b·ªô nh·ªõ?

**·ª®ng vi√™n:** R√≤ r·ªâ b·ªô nh·ªõ x·∫£y ra khi c√°c ƒë·ªëi t∆∞·ª£ng kh√¥ng c√≤n s·ª≠ d·ª•ng ƒë∆∞·ª£c kh√¥ng th·ªÉ ƒë∆∞·ª£c GC thu h·ªìi v√† ti·∫øp t·ª•c chi·∫øm b·ªô nh·ªõ, d·∫´n ƒë·∫øn l√£ng ph√≠ kh√¥ng gian v√† cu·ªëi c√πng c√≥ th·ªÉ g√¢y ra tr√†n b·ªô nh·ªõ. Tr√†n b·ªô nh·ªõ x·∫£y ra khi ch∆∞∆°ng tr√¨nh y√™u c·∫ßu b·ªô nh·ªõ m√† kh√¥ng c√≤n ƒë·ªß kh√¥ng gian, d·∫´n ƒë·∫øn l·ªói `OutOfMemoryError`.

**Nh√† tuy·ªÉn d·ª•ng:** OK, b·∫°n c√≥ bi·∫øt nguy√™n nh√¢n th·ª±c s·ª± c·ªßa vi·ªác r√≤ r·ªâ b·ªô nh·ªõ v·ªõi ThreadLocal l√† g√¨ kh√¥ng?

**·ª®ng vi√™n:** Th·ª© nh·∫•t, n·∫øu kh√¥ng x√≥a c√°c ƒë·ªëi t∆∞·ª£ng Entry th·ªß c√¥ng, b·∫°n c√≥ th·ªÉ g·ªçi ph∆∞∆°ng th·ª©c `remove` c·ªßa ThreadLocal sau khi s·ª≠ d·ª•ng ƒë·ªÉ x√≥a Entry t∆∞∆°ng ·ª©ng v√† tr√°nh r√≤ r·ªâ b·ªô nh·ªõ. Th·ª© hai, vi·ªác s·ª≠ d·ª•ng ThreadLocal c·∫ßn ƒë∆∞·ª£c d·ªçn d·∫πp khi lu·ªìng k·∫øt th√∫c.

Nguy√™n nh√¢n g·ªëc r·ªÖ l√† v√≤ng ƒë·ªùi c·ªßa ThreadLocalMap v√† lu·ªìng l√† nh∆∞ nhau.

**Nh√† tuy·ªÉn d·ª•ng:** OK, b·∫°n c√≥ bi·∫øt ThreadLocalMap gi·∫£i quy·∫øt xung ƒë·ªôt hash nh∆∞ th·∫ø n√†o kh√¥ng?

**·ª®ng vi√™n:** N·∫øu c√≥ xung ƒë·ªôt hash, ch·ªâ s·ªë trong m·∫£ng s·∫Ω ƒë∆∞·ª£c tƒÉng l√™n 1. N·∫øu xung ƒë·ªôt v·∫´n c√≤n, t√≠nh to√°n ti·∫øp cho ƒë·∫øn khi v∆∞·ª£t qu√° ch·ªâ s·ªë m·∫£ng, l√∫c n√†y s·∫Ω quay l·∫°i b·∫Øt ƒë·∫ßu, t∆∞∆°ng t·ª± nh∆∞ m·ªôt m·∫£ng v√≤ng tr√≤n.

**Nh√† tuy·ªÉn d·ª•ng:** B·∫°n c√≥ th·ªÉ m√¥ t·∫£ chi ti·∫øt c√°c b∆∞·ªõc tri·ªÉn khai TTL ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu ng∆∞·ªùi d√πng kh√¥ng?

**·ª®ng vi√™n:** Sau khi ng∆∞·ªùi d√πng ƒëƒÉng nh·∫≠p, m·ªôt m√£ th√¥ng b√°o s·∫Ω ƒë∆∞·ª£c tr·∫£ v·ªÅ v√† c√°c y√™u c·∫ßu sau ƒë√≥ s·∫Ω mang theo m√£ th√¥ng b√°o n√†y. M√£ th√¥ng b√°o ch·ª©a th√¥ng tin ng∆∞·ªùi d√πng. T·∫•t c·∫£ c√°c y√™u c·∫ßu ƒë·∫ßu ti√™n ƒëi qua b·ªô l·ªçc AuthFilter c·ªßa gateway, trong b·ªô l·ªçc n√†y, th√¥ng tin ng∆∞·ªùi d√πng ƒë∆∞·ª£c ƒë·∫∑t v√†o ti√™u ƒë·ªÅ y√™u c·∫ßu. Sau khi ƒëi qua gateway, c√°c y√™u c·∫ßu ƒë·∫øn b·ªô l·ªçc ti√™u ƒë·ªÅ HeaderInterceptor t√πy ch·ªânh, n∆°i th√¥ng tin ng∆∞·ªùi d√πng t·ª´ ti√™u ƒë·ªÅ y√™u c·∫ßu ƒë∆∞·ª£c ƒë∆∞a v√†o TTL. Nh∆∞ v·∫≠y, c√°c d·ªãch v·ª• tr√™n chu·ªói c√≥ th·ªÉ tr·ª±c ti·∫øp l·∫•y th√¥ng tin ng∆∞·ªùi d√πng t·ª´ TTL.

**Nh√† tuy·ªÉn d·ª•ng:** TTL c√≥ ·∫£nh h∆∞·ªüng ƒë·∫øn hi·ªáu su·∫•t kh√¥ng? B·∫°n ƒë√£ t·ªëi ∆∞u h√≥a hi·ªáu su·∫•t nh∆∞ th·∫ø n√†o?

**·ª®ng vi√™n:** Vi·ªác s·ª≠ d·ª•ng TTL th·ª±c s·ª± c√≥ m·ªôt s·ªë chi ph√≠ hi·ªáu su·∫•t, ƒë·∫∑c bi·ªát trong c√°c k·ªãch b·∫£n t·∫°o v√† h·ªßy lu·ªìng th∆∞·ªùng xuy√™n. ƒê·ªÉ t·ªëi ∆∞u h√≥a hi·ªáu su·∫•t, ch√∫ng t√¥i ƒë√£ gi·∫£m thi·ªÉu s·ªë l·∫ßn t·∫°o v√† h·ªßy lu·ªìng v√† theo d√µi vi·ªác s·ª≠ d·ª•ng TTL ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng g√¢y ra r√≤ r·ªâ b·ªô nh·ªõ ho·∫∑c t·∫Øc ngh·∫Ωn hi·ªáu su·∫•t.

**Nh√† tuy·ªÉn d·ª•ng:** Trong d·ª± √°n c·ªßa b·∫°n, b·∫°n ƒë√£ g·∫∑p ph·∫£i v·∫•n ƒë·ªÅ r√≤ r·ªâ b·ªô nh·ªõ do TTL g√¢y ra ch∆∞a? N·∫øu c√≥, b·∫°n ƒë√£ gi·∫£i quy·∫øt nh∆∞ th·∫ø n√†o?

**·ª®ng vi√™n:** C√≥, ch√∫ng t√¥i ƒë√£ g·∫∑p ph·∫£i m·ªôt v·∫•n ƒë·ªÅ r√≤ r·ªâ b·ªô nh·ªõ do s·ª≠ d·ª•ng TTL kh√¥ng ƒë√∫ng c√°ch. Nguy√™n nh√¢n l√† m·ªôt s·ªë lu·ªìng ch·∫°y l√¢u d√†i kh√¥ng d·ªçn d·∫πp c√°c bi·∫øn ThreadLocal m√† ch√∫ng gi·ªØ. ƒê·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ n√†y, ch√∫ng t√¥i ƒë√£ ƒë·∫£m b·∫£o d·ªçn d·∫πp c√°c bi·∫øn ThreadLocal li√™n quan sau m·ªói y√™u c·∫ßu trong ph∆∞∆°ng th·ª©c `afterCompletion` c·ªßa HeaderInterceptor. Ch√∫ng t√¥i c≈©ng th√™m c∆° ch·∫ø ki·ªÉm tra v√† d·ªçn d·∫πp ƒë·ªãnh k·ª≥ ƒë·ªÉ ngƒÉn ng·ª´a r√≤ r·ªâ b·ªô nh·ªõ.

**Nh√† tuy·ªÉn d·ª•ng:** Khi s·ª≠ d·ª•ng TTL, b·∫°n ƒë√£ g·∫∑p ph·∫£i v·∫•n ƒë·ªÅ ƒë·ªìng th·ªùi ch∆∞a? N·∫øu c√≥, b·∫°n ƒë√£ x·ª≠ l√Ω nh∆∞ th·∫ø n√†o?

**·ª®ng vi√™n:** Khi s·ª≠ d·ª•ng TTL, v√¨ m·ªói lu·ªìng c√≥ m·ªôt th·ªÉ hi·ªán bi·∫øn ThreadLocal ri√™ng bi·ªát, n√™n v·∫•n ƒë·ªÅ ƒë·ªìng th·ªùi th∆∞·ªùng kh√¥ng x·∫£y ra. Tuy nhi√™n, ch√∫ng t√¥i ƒë√£ g·∫∑p ph·∫£i t√¨nh tr·∫°ng gi√° tr·ªã TTL b·ªã s·ª≠a ƒë·ªïi sai trong c√°c t√¨nh hu·ªëng ƒë·ªìng th·ªùi cao. ƒê·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ n√†y, ch√∫ng t√¥i ƒë√£ th√™m c∆° ch·∫ø ƒë·ªìng b·ªô h√≥a trong c√°c ƒëo·∫°n m√£ quan tr·ªçng v√† s·ª≠ d·ª•ng c√°c t·∫≠p h·ª£p an to√†n lu·ªìng ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu chia s·∫ª, nh·∫±m tr√°nh vi·ªác s·ª≠a ƒë·ªïi ƒë·ªìng th·ªùi.

**Nh√† tuy·ªÉn d·ª•ng:** B·∫°n c√≥ th·ªÉ n√™u m·ªôt s·ªë v√≠ d·ª• c·ª• th·ªÉ v·ªÅ c√°c t√¨nh hu·ªëng s·ª≠ d·ª•ng TTL trong d·ª± √°n c·ªßa b·∫°n kh√¥ng?

**·ª®ng vi√™n:** T·∫•t nhi√™n. Trong d·ª± √°n c·ªßa ch√∫ng t√¥i, c√≥ m·ªôt t√¨nh hu·ªëng l√† ghi l·∫°i nh·∫≠t k√Ω ho·∫°t ƒë·ªông sau khi ng∆∞·ªùi d√πng ƒëƒÉng nh·∫≠p. B·∫±ng c√°ch s·ª≠ d·ª•ng TTL, ch√∫ng t√¥i c√≥ th·ªÉ l·∫•y th√¥ng tin chi ti·∫øt c·ªßa ng∆∞·ªùi d√πng khi ghi nh·∫≠t k√Ω ƒë·ªìng th·ªùi, ƒë·∫£m b·∫£o t√≠nh ch√≠nh x√°c c·ªßa nh·∫≠t k√Ω. M·ªôt v√≠ d·ª• kh√°c l√† qu·∫£n l√Ω giao d·ªãch ph√¢n t√°n, th√¥ng qua TTL ƒë·ªÉ truy·ªÅn b·ªëi c·∫£nh giao d·ªãch, ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n c·ªßa giao d·ªãch gi·ªØa c√°c d·ªãch v·ª•. Th√™m v√†o ƒë√≥, trong m·ªôt s·ªë t√¨nh hu·ªëng c·∫ßn truy·ªÅn d·ªØ li·ªáu qua c√°c lu·ªìng, nh∆∞ x√°c th·ª±c ng∆∞·ªùi d√πng trong c√°c t√°c v·ª• b·∫•t ƒë·ªìng b·ªô, ch√∫ng t√¥i c≈©ng s·ª≠ d·ª•ng TTL ƒë·ªÉ truy·ªÅn v√† l∆∞u tr·ªØ d·ªØ li·ªáu ng∆∞·ªùi d√πng.